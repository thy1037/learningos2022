# 2022 开源操作系统学习笔记
2022.7.1 网上冲浪时发现了由清华大学、CSDN、毛豆教育等共同举办的[2022年开源系统系统训练营](https://github.com/LearningOS/rust-based-os-comp2022/blob/main/scheduling.md)活动。异常兴奋！之前很长一段时间内利用碎片时间学习了 Rust 语言，并初步了解了计算机操作系统，因为个人工作是使用C语言、嵌入式实时操作系统进行产品开发，所以对基于 Rust 的计算机操作系统开发非常感兴趣，观看、学习了计算机操作系统的相关的教学视频后，好奇并希望完成相关 Lab，但一直没有找到较好的资源。现在这个训练营提供了完备的学习计划、实验内容，并且有多位老师、助教全程指导，上百位爱好者共同学习、交流，能够系统地学习 Rust 语言和计算机操作系统，堪称完美，希望能坚持到底。

作为从业者，因为工作和家庭的原因，每天没有太多的时间专用于此次训练营活动，基本每天能够早上1.5个小时，晚上小于1个小时。不管是 Rust 还是计算机操作系统，都还只是入门甚至未入门的状态，每天完成的内容非常有限，所以将每日内容记录在 `git commit` 中，周末总结一篇周记，这是适用于我的学习过程记录方式。

## Weekly 1 (7.3 ~ 7.10)
### 内容
#### 1. 查看活动安排

详细查看了训练营的活动安排，分为两个阶段，现开放第一阶段活动，根据第一阶段的完成度决定是否可以进入第二阶段。第一阶段主要分三步：
* step 0 自学 Rust 编程 （大约7～14天）
* step 1 自学 risc-v 系统结构（大约2~7天）
* step 2 基于Rust语言进行操作系统内核实验--based on qemu （大约14~31天）

#### 2. 完成 rustlings

根据训练营计划的 [Step0](https://github.com/LearningOS/rust-based-os-comp2022/blob/main/scheduling.md#step-0-%E8%87%AA%E5%AD%A6rust%E7%BC%96%E7%A8%8B%E5%A4%A7%E7%BA%A6714%E5%A4%A9) 描述内容，花了一周的时间完成了 [rustlings](https://github.com/LearningOS/learn_rust_rustlings-thy1037) 。纯粹只是完成了全部的习题，没有深入体会考核意图，甚至没弄明白的答案的原理。

整套练习共 84 小题，个人认为涵盖了 Rust 除生命周期外的所有内容，都是一些浅显的考核内容。

但即使如此，从 `error_handling` 开始的习题，明显感觉知识掌握不够，需要借助翻阅资料完成。之前的内容是一些基本数据类型、语法定义，与 C语言大同小异，从这里开始就是一些 Rust 特有的数据类型、语法，错误处理是 Rust 的特色之一，C语言中的多用函数返回值判断错误标示，用 `goto` 方式集中处理错误内容，繁琐且覆盖不全，代码难以阅读，而 Rust 使用特有的 `Option`、`Result` 数据类型来定义和处理错误，`enum` 于C语言也有非常大的区别，要深入理解并熟练掌握使用这三个数据类型，需要大量的代码积累。

从 `conversions` 章节开始，部分题目已无法独立完成，需要在网上寻找答案，根据答案进行分析理解。Rust 另一个难点在于类型转换，C语言中可以使用强制类型转换，更是存在 `void *` 这种极致自由的任意门类型，为了安全，Rust 的数据类型设计的没有那么显然，这也是与编译器作斗争的主要原因，让熟悉 C语言的人概念转换过于艰难，要掌握 Rust 的类型转换需要熟悉每种类型自带的转换方法，如 `to_string()`、`collect()`等，并理解每种类型的设计需求，类型间的关系、关联。这些也都只能在后续的实验中，通过阅读大量的代码逐步加深理解。

掌握人类语言需要多说多听，掌握计算机语言则需要多写多看，代码量是掌握程度的唯一标准。就像张汉东老师说的，大致的意思是：不存在某一个瞬间就突然学会了 Rust。

### 计划
根据活动安排，接下来自学 risc-v，从特权模式、汇编语言入手，两天时间先过一遍所有的汇编指令。

## Weekly 2 (7.11 ~ 7.17)
### 内容
#### 1. RSIC-V 汇编指令

观看[计算机组成与设计：RISC-V【浙江大学】](https://www.bilibili.com/video/BV1tz411z7GN)的P1～P15，并做了相关笔记[2.1 汇编指令](asm-code.md)，视频主要讲解了 RV32 的基础汇编指令、指令编码格式和芯片内部硬件设计原理，纯粹只是心中有数，并没有做任何实战代码练习

#### 2. LAB1
完成了 LAB1，该实验分三个小项目，其中前两个不用作代码修改就可以通过 Github CI 评分，所以一开始并没有特别关注这两个小实验的内容，结果在第三部分卡壳，返回仔细学习前两个小项目的讲义，为了完成 LAB1 的简答题，讲义反阅读多遍。**不要欠下技术债**，这不仅是 Rust 语言传达的教义，更适用于所有场景。

其中第二个项目，需要修改 `overwrite.py` 中的一段内容，修改后 Github CI 通过未及时看到，又修改了其它部分代码，导致 CI 一直没能通过，发现时将所做修改复原依旧没能通过，不得以通过 Git 回滚的方式回到通过状态。没弄明白其中原因，特作记录。

[LAB1 实验报告](rust-based-os-comp2022-lab1.md)

### 计划
下周需要完成 LAB2 和 LAB 3，任务艰巨。 

## Weekly 3 (7.18 ~ 7.24)
### 内容
#### 1. 地址空间
这是 CH4-LAB2 的实验内容，这一章的内容是计算机操作系统与嵌入式实时操作系统（FreeRTOS、RT-Thread 这类）的首个也是最大的不同之处：虚拟地址。在不带 `mmu` 的微处理上无法实现操作系统内核与用户程序、程序与程序间的内存、特权级隔离。一直没有深入了解过内存管理、虚拟地址、特权级，这一章中学习并使用了虚拟地址、特权级切换，对我个人来讲难度很大，收获更大。

这一章中学到了SV39多级页表的相关知识，包括硬件机制和软件实现。页表项的数据结构、虚拟地址与物理地址的映射，以及惰性加载，有了虚拟地址，可以大大降低了应用的程序的开发难度、简化了程序的逻辑，更是加强了整个系统的稳定性，内核对于应用程序不可见、不可修改，应用的稳定性、安全性一定程度上不再能影响到内核，内核有了对应用程序的监控能力。

可以将这部分的内容、机制、思想，简化后应用到RTOS开发中，不管是RTOS内核还是应用程序。

[LAB2 实验报告](rust-based-os-comp2022-lab2.md)

#### 2. 进程及进程管理
这是 CH5-LAB3 的实验内容，引入了进程的概念，不同于RTOS中的任务、线程，RTOS可以通过特殊方法曲线实现动态加载应用，但无法做到地址空间的隔离，更无法做到特权级的隔离。

进程可以说是有了地址空间后的自然产物，前几章中的任务概念的改进版。主要是引入 `fork` 这个非常巧妙的系统调用，将程序扩展方式一下子放大，并且参数传递非常方便，配合 `exec` 可以很方便的启动新执行流。

增加了新的进程调度机制，`stride` 算法实现了进程优先级，对比时间片轮询机制更具普适性，但调度机制本身就很复杂，这里简单的借此简单地学习进程管理。

[LAB3 实验报告](rust-based-os-comp2022-lab3.md)

### 计划
根据活动安排，第一阶段只剩一周时间，还有 LAB4 、LAB5 两个实验没有完成，任务艰巨。
